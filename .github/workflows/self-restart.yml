name: Self Restart Test

on:
  merge_group:
    branches: [main]
  pull_request:
    branches: ["*"]

jobs:
  self-restart-test:
    name: Self Restart on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            ant_data_path: /home/runner/.local/share/autonomi
            node_data_path: /home/runner/.local/share/autonomi/node
            self_restart_path: /home/runner/.local/share/autonomi/self_restart_node
            shell_type: bash
          - os: windows-latest
            ant_data_path: C:\Users\runneradmin\AppData\Roaming\autonomi
            node_data_path: C:\Users\runneradmin\AppData\Roaming\autonomi\node
            self_restart_path: C:\Users\runneradmin\AppData\Roaming\autonomi\self_restart_node
            shell_type: pwsh
          - os: macos-latest
            ant_data_path: /Users/runner/Library/Application Support/autonomi
            node_data_path: /Users/runner/Library/Application Support/autonomi/node
            self_restart_path: /Users/runner/Library/Application Support/autonomi/self_restart_node
            shell_type: bash
    env:
      ANT_DATA_PATH: ${{ matrix.ant_data_path }}
      NODE_DATA_PATH: ${{ matrix.node_data_path }}
      SELF_RESTART_TEST_NODE_DATA_PATH: ${{ matrix.self_restart_path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check we're on the right commit
        run: git log -1 --oneline

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        continue-on-error: true

      - name: install ripgrep (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: sudo apt-get install -y ripgrep

      - name: install ripgrep (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: brew install ripgrep

      - name: install ripgrep (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: choco install ripgrep -y

      - name: Build binaries
        run: cargo build --release --bin antnode --bin ant
        timeout-minutes: 30

      - name: Start a local network
        uses: maidsafe/ant-local-testnet-action@main
        with:
          action: start
          enable-evm-testnet: true
          node-path: target/release/antnode
          build: true

      - name: Check ANT_PEERS was set (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: echo "The ANT_PEERS variable has been set to $ANT_PEERS"

      - name: Check ANT_PEERS was set (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: Write-Output "The ANT_PEERS variable has been set to $env:ANT_PEERS"

      - name: export default secret key (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: echo "SECRET_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" >> $GITHUB_ENV

      - name: export default secret key (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: echo "SECRET_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" >> $env:GITHUB_ENV

      - name: Start a node instance with auto-restart after 2 minutes (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          mkdir -p "$SELF_RESTART_TEST_NODE_DATA_PATH"
          ./target/release/antnode \
            --root-dir "$SELF_RESTART_TEST_NODE_DATA_PATH" \
            --log-output-dest "$SELF_RESTART_TEST_NODE_DATA_PATH" \
            --local \
            --rewards-address "0x03B770D9cD32077cC0bF330c13C114a87643B124" \
            --auto-restart-delay 120 &
          echo "Started node with auto-restart delay of 120 seconds"
          sleep 10
        env:
          ANT_LOG: "all"

      - name: Start a node instance with auto-restart after 2 minutes (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:SELF_RESTART_TEST_NODE_DATA_PATH"
          
          Write-Output "=== Environment Check ==="
          Write-Output "ANT_LOG: $env:ANT_LOG"
          Write-Output "Working Directory: $(Get-Location)"
          Write-Output "Executable Path: $(Resolve-Path '.\target\release\antnode.exe')"
          Write-Output "Data Path: $env:SELF_RESTART_TEST_NODE_DATA_PATH"
          
          # Build the command with proper quoting
          $exePath = (Resolve-Path ".\target\release\antnode.exe").Path
          $cmdArgs = "--root-dir `"$env:SELF_RESTART_TEST_NODE_DATA_PATH`" --log-output-dest `"$env:SELF_RESTART_TEST_NODE_DATA_PATH`" --local --rewards-address 0x03B770D9cD32077cC0bF330c13C114a87643B124 --auto-restart-delay 120"
          
          Write-Output "=== Starting Node (Detached) ==="
          Write-Output "Command: `"$exePath`" $cmdArgs"
          
          # Use cmd.exe to start a truly detached background process
          # /C = run command and terminate
          # start = start a new process
          # /B = start without creating a new window (background)
          # "" = empty title for the window (required parameter for start command)
          $startCmd = "cmd.exe /C start /B `"`" `"$exePath`" $cmdArgs"
          Write-Output "Start command: $startCmd"
          
          # Execute the detached start command
          Invoke-Expression $startCmd
          
          Write-Output "Process start command issued, waiting for node to initialize..."
          Start-Sleep -Seconds 5
          
          # Check if PID file was created
          $pidFile = Join-Path $env:SELF_RESTART_TEST_NODE_DATA_PATH "antnode.pid"
          if (Test-Path $pidFile) {
            $nodePid = Get-Content $pidFile
            Write-Output "✓ PID file created with PID: $nodePid"
            
            # Verify the process is running
            $process = Get-Process -Id $nodePid -ErrorAction SilentlyContinue
            if ($process) {
              Write-Output "✓ Node process is running"
              Write-Output "Process Name: $($process.ProcessName)"
              Write-Output "Start Time: $($process.StartTime)"
              Write-Output "Process ID: $($process.Id)"
            } else {
              Write-Output "✗ ERROR: PID file exists but process is not running!"
              Write-Output "This indicates the node started but then terminated."
              Write-Output "Checking logs..."
              if (Test-Path "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log") {
                Write-Output "=== Log Contents (last 100 lines) ==="
                Get-Content "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log" -Tail 100
              }
              exit 1
            }
            
            Write-Output "Waiting additional 5 seconds to verify stability..."
            Start-Sleep -Seconds 5
            
            # Final verification
            $finalCheck = Get-Process -Id $nodePid -ErrorAction SilentlyContinue
            if ($finalCheck) {
              Write-Output "✓ Node successfully started and running for 10 seconds"
              Write-Output "The process is detached and will continue running"
            } else {
              Write-Output "✗ ERROR: Process terminated during startup!"
              if (Test-Path "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log") {
                Write-Output "=== Log Contents ==="
                Get-Content "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log" -Tail 100
              }
              exit 1
            }
          } else {
            Write-Output "✗ ERROR: PID file not created after 5 seconds"
            Write-Output "This indicates the node failed to start properly."
            Write-Output "Checking for any antnode processes:"
            Get-Process -Name antnode -ErrorAction SilentlyContinue | Format-Table
            Write-Output "Checking logs..."
            if (Test-Path "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log") {
              Write-Output "=== Log Contents ==="
              Get-Content "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log" -Tail 100
            } else {
              Write-Output "No log file found"
            }
            exit 1
          }
        env:
          ANT_LOG: "all"

      - name: Record initial PID (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          INITIAL_PID=$(cat "$SELF_RESTART_TEST_NODE_DATA_PATH/antnode.pid")
          echo "INITIAL_PID=$INITIAL_PID" >> $GITHUB_ENV
          echo "Initial node PID: $INITIAL_PID"

      - name: Record initial PID (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $INITIAL_PID = Get-Content "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.pid"
          echo "INITIAL_PID=$INITIAL_PID" >> $env:GITHUB_ENV
          Write-Output "Initial node PID: $INITIAL_PID"

      - name: Verify node is running (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          if ps -p $INITIAL_PID > /dev/null 2>&1; then
            echo "Node is running with PID: $INITIAL_PID"
            echo "All antnode processes:"
            ps aux | grep "[a]ntnode" || echo "No antnode processes found in ps"
          else
            echo "Node process not found!"
            exit 1
          fi

      - name: Verify node is running (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $process = Get-Process -Id $env:INITIAL_PID -ErrorAction SilentlyContinue
          if ($process) {
            Write-Output "Node is running with PID: $env:INITIAL_PID"
            Write-Output "Process start time: $($process.StartTime)"
            Write-Output "All antnode processes:"
            Get-Process -Name antnode -ErrorAction SilentlyContinue | Format-Table Id, StartTime, CPU
          } else {
            Write-Output "ERROR: Node process not found!"
            Write-Output "All antnode processes:"
            Get-Process -Name antnode -ErrorAction SilentlyContinue | Format-Table Id, StartTime, CPU
            Write-Output "Checking if process exited immediately - checking logs:"
            if (Test-Path "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log") {
              Get-Content "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log" -Tail 50
            }
            exit 1
          }

      - name: Wait for 1 minute (halfway to restart) (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          echo "Waiting 60 seconds (halfway to restart time)..."
          sleep 60

      - name: Wait for 1 minute (halfway to restart) (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Output "Waiting 60 seconds (halfway to restart time)..."
          Start-Sleep -Seconds 60

      - name: Verify node is still running with same PID (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          if ps -p $INITIAL_PID > /dev/null 2>&1; then
            echo "Node is still running with PID: $INITIAL_PID (as expected)"
            echo "All antnode processes:"
            ps aux | grep "[a]ntnode" || echo "No antnode processes found in ps"
          else
            echo "Node process terminated prematurely!"
            echo "All antnode processes:"
            ps aux | grep "[a]ntnode" || echo "No antnode processes found in ps"
            exit 1
          fi

      - name: Verify node is still running with same PID (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $process = Get-Process -Id $env:INITIAL_PID -ErrorAction SilentlyContinue
          if ($process) {
            Write-Output "Node is still running with PID: $env:INITIAL_PID (as expected)"
            Write-Output "Process uptime: $(((Get-Date) - $process.StartTime).TotalSeconds) seconds"
            Write-Output "All antnode processes:"
            Get-Process -Name antnode -ErrorAction SilentlyContinue | Format-Table Id, StartTime, CPU
          } else {
            Write-Output "ERROR: Node process terminated prematurely!"
            Write-Output "All antnode processes:"
            Get-Process -Name antnode -ErrorAction SilentlyContinue | Format-Table Id, StartTime, CPU
            exit 1
          }

      - name: Wait additional time for restart to occur (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          echo "Waiting additional 90 seconds for restart to occur..."
          sleep 90
          echo "Restart time should have elapsed. Checking processes..."
          ps aux | grep "[a]ntnode" || echo "No antnode processes found in ps"
          echo "Giving additional 10 seconds for new process to fully start and write PID..."
          sleep 10

      - name: Wait additional time for restart to occur (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Output "Waiting additional 90 seconds for restart to occur..."
          Start-Sleep -Seconds 90
          Write-Output "Restart time should have elapsed. Checking processes..."
          Get-Process -Name antnode -ErrorAction SilentlyContinue | Format-Table
          Write-Output "Giving additional 10 seconds for new process to fully start and write PID..."
          Start-Sleep -Seconds 10

      - name: Verify node restarted (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          echo "Checking for new node process..."
          
          # Wait up to 20 seconds for new PID file to be written
          max_attempts=20
          attempt=0
          new_pid_found=false
          
          while [ $attempt -lt $max_attempts ]; do
            if [ -f "$SELF_RESTART_TEST_NODE_DATA_PATH/antnode.pid" ]; then
              NEW_PID=$(cat "$SELF_RESTART_TEST_NODE_DATA_PATH/antnode.pid")
              
              # Check if PID changed
              if [ "$NEW_PID" != "$INITIAL_PID" ]; then
                echo "Found new PID: $NEW_PID (different from initial PID: $INITIAL_PID)"
                new_pid_found=true
                break
              else
                echo "Attempt $attempt: PID file still contains old PID: $NEW_PID"
              fi
            else
              echo "Attempt $attempt: PID file not found yet"
            fi
            
            attempt=$((attempt + 1))
            sleep 1
          done
          
          # Verify we found a new PID
          if [ "$new_pid_found" = false ]; then
            echo "ERROR: New PID not found after waiting"
            ls -la "$SELF_RESTART_TEST_NODE_DATA_PATH/"
            exit 1
          fi
          
          # Verify the new process is actually running
          if ps -p $NEW_PID > /dev/null 2>&1; then
            echo "SUCCESS: New node process is running with PID: $NEW_PID"
          else
            echo "ERROR: New PID found in file but process is not running!"
            echo "Checking all antnode processes:"
            ps aux | grep antnode || echo "No antnode processes found"
            exit 1
          fi
          
          echo "SUCCESS: Node restarted successfully! PID changed from $INITIAL_PID to $NEW_PID"

      - name: Verify node restarted (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Output "Checking for new node process..."
          
          # Wait up to 20 seconds for new PID file to be written
          $max_attempts = 20
          $attempt = 0
          $new_pid_found = $false
          $NEW_PID = $null
          
          while ($attempt -lt $max_attempts) {
            $pidFile = Join-Path $env:SELF_RESTART_TEST_NODE_DATA_PATH "antnode.pid"
            if (Test-Path $pidFile) {
              $NEW_PID = Get-Content $pidFile
              
              # Check if PID changed
              if ($NEW_PID -ne $env:INITIAL_PID) {
                Write-Output "Found new PID: $NEW_PID (different from initial PID: $env:INITIAL_PID)"
                $new_pid_found = $true
                break
              } else {
                Write-Output "Attempt $attempt : PID file still contains old PID: $NEW_PID"
              }
            } else {
              Write-Output "Attempt $attempt : PID file not found yet"
            }
            
            $attempt++
            Start-Sleep -Seconds 1
          }
          
          # Verify we found a new PID
          if (-not $new_pid_found) {
            Write-Output "ERROR: New PID not found after waiting"
            Get-ChildItem $env:SELF_RESTART_TEST_NODE_DATA_PATH
            exit 1
          }
          
          # Verify the new process is actually running
          $process = Get-Process -Id $NEW_PID -ErrorAction SilentlyContinue
          if ($process) {
            Write-Output "SUCCESS: New node process is running with PID: $NEW_PID"
            Write-Output "Process start time: $($process.StartTime)"
          } else {
            Write-Output "ERROR: New PID found in file but process is not running!"
            Write-Output "Checking all antnode processes:"
            Get-Process -Name antnode -ErrorAction SilentlyContinue | Format-Table Id, StartTime, CPU
            exit 1
          }
          
          Write-Output "SUCCESS: Node restarted successfully! PID changed from $env:INITIAL_PID to $NEW_PID"

      - name: Check for restart log messages (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          echo "Checking for auto-restart log messages..."
          if rg "Auto-restart enabled" "$SELF_RESTART_TEST_NODE_DATA_PATH"; then
            echo "✓ Found auto-restart enabled message"
          else
            echo "⚠ Warning: Auto-restart enabled message not found"
          fi
          
          if rg "Auto-restart delay elapsed" "$SELF_RESTART_TEST_NODE_DATA_PATH"; then
            echo "✓ Found auto-restart delay elapsed message"
          else
            echo "⚠ Warning: Auto-restart delay elapsed message not found"
          fi
          
          if rg "Node is restarting" "$SELF_RESTART_TEST_NODE_DATA_PATH"; then
            echo "✓ Found node restarting message"
          else
            echo "⚠ Warning: Node restarting message not found"
          fi
          
          if rg "Successfully spawned new node process" "$SELF_RESTART_TEST_NODE_DATA_PATH"; then
            echo "✓ Found successfully spawned new node process message"
            # Extract the PID from the log message
            spawned_pid=$(rg "Successfully spawned new node process with PID: (\d+)" -o -r '$1' "$SELF_RESTART_TEST_NODE_DATA_PATH" | head -1)
            if [ -n "$spawned_pid" ]; then
              echo "  Spawned PID from log: $spawned_pid"
            fi
          else
            echo "⚠ Warning: Successfully spawned message not found"
          fi
          
          if rg "A new node process has been started" "$SELF_RESTART_TEST_NODE_DATA_PATH"; then
            echo "✓ Found new node process started message"
          else
            echo "ℹ Note: New node process message may be in different log"
          fi

      - name: Check for restart log messages (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Output "Checking for auto-restart log messages..."
          
          # Use -q (quiet) to just check if pattern exists, returns 0 if found
          $logPath = Join-Path $env:SELF_RESTART_TEST_NODE_DATA_PATH "antnode.log"
          
          if (Test-Path $logPath) {
            Write-Output "Checking log file: $logPath"
            
            # Check for auto-restart enabled
            rg "Auto-restart enabled" "$logPath" -q
            if ($LASTEXITCODE -eq 0) {
              Write-Output "✓ Found auto-restart enabled message"
            } else {
              Write-Output "⚠ Warning: Auto-restart enabled message not found"
            }
            
            # Check for auto-restart delay elapsed
            rg "Auto-restart delay elapsed" "$logPath" -q
            if ($LASTEXITCODE -eq 0) {
              Write-Output "✓ Found auto-restart delay elapsed message"
            } else {
              Write-Output "⚠ Warning: Auto-restart delay elapsed message not found"
            }
            
            # Check for node restarting
            rg "Node is restarting" "$logPath" -q
            if ($LASTEXITCODE -eq 0) {
              Write-Output "✓ Found node restarting message"
            } else {
              Write-Output "⚠ Warning: Node restarting message not found"
            }
            
            # Check for successfully spawned and extract PID
            rg "Successfully spawned new node process" "$logPath" -q
            if ($LASTEXITCODE -eq 0) {
              Write-Output "✓ Found successfully spawned new node process message"
              # Extract just the PID number using proper regex
              $spawnedPidLine = rg "Successfully spawned new node process with PID: (\d+)" "$logPath" -o --no-filename --no-line-number | Select-Object -First 1
              if ($spawnedPidLine -match "PID: (\d+)") {
                Write-Output "  Spawned PID from log: $($matches[1])"
              }
            } else {
              Write-Output "⚠ Warning: Successfully spawned message not found"
            }
            
            # Check for new node process started (informational only)
            rg "A new node process has been started" "$logPath" -q
            if ($LASTEXITCODE -eq 0) {
              Write-Output "✓ Found new node process started message"
            } else {
              Write-Output "ℹ Note: New node process message may be in different log"
            }
            
            Write-Output "Log check complete - all checks are informational only"
          } else {
            Write-Output "⚠ Warning: Log file not found at $logPath"
          }
          
          # Ensure the step exits successfully (log checks are informational)
          exit 0

      - name: Verify restarted node functionality by uploading a small file (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          # Create a small test file
          echo "This is a test file to verify the restarted node works" > test_file.txt
          ./target/release/ant --log-output-dest=data-dir --local file upload --public "./test_file.txt" --retry-failed 3
        env:
          ANT_LOG: "v"
        timeout-minutes: 2

      - name: Verify restarted node functionality by uploading a small file (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Create a small test file
          "This is a test file to verify the restarted node works" | Out-File -FilePath test_file.txt
          .\target\release\ant.exe --log-output-dest=data-dir --local file upload --public ".\test_file.txt" --retry-failed 3
        env:
          ANT_LOG: "v"
        timeout-minutes: 2

      - name: Show self-restart test node logs (Unix)
        if: always() && matrix.os != 'windows-latest'
        shell: bash
        run: cat "$SELF_RESTART_TEST_NODE_DATA_PATH/antnode.log"
        continue-on-error: true

      - name: Show self-restart test node logs (Windows)
        if: always() && matrix.os == 'windows-latest'
        shell: pwsh
        run: Get-Content "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log"
        continue-on-error: true

      - name: Stop the local network and upload logs
        if: always()
        uses: maidsafe/ant-local-testnet-action@main
        with:
          action: stop
          log_file_prefix: ant_test_logs_self_restart
          build: true

      - name: Move self_restart_node log to the working directory (Unix)
        if: always() && matrix.os != 'windows-latest'
        shell: bash
        run: |
          ls -l "$SELF_RESTART_TEST_NODE_DATA_PATH"
          mv "$SELF_RESTART_TEST_NODE_DATA_PATH/antnode.log" ./self_restart_node.log
        continue-on-error: true
        timeout-minutes: 1

      - name: Move self_restart_node log to the working directory (Windows)
        if: always() && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Get-ChildItem "$env:SELF_RESTART_TEST_NODE_DATA_PATH"
          Move-Item "$env:SELF_RESTART_TEST_NODE_DATA_PATH\antnode.log" .\self_restart_node.log
        continue-on-error: true
        timeout-minutes: 1

      - name: Upload self_restart_node log
        uses: actions/upload-artifact@main
        with:
          name: self_restart_test_node_log_${{ matrix.os }}
          path: self_restart_node.log
        continue-on-error: true
        if: always()

